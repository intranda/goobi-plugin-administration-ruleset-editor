<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:composite="http://xmlns.jcp.org/jsf/composite"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites"
	xmlns:jsf="http://xmlns.jcp.org/jsf"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:x="http://myfaces.apache.org/tomahawk">

	<composite:interface>
	</composite:interface>

	<composite:implementation>
		<link rel="stylesheet" href="template/css/codemirror/codemirror.css?v=#{HelperForm.buildVersion}"/>
		<script type="text/javascript" src="template/js/codemirror/codemirror.js?v=#{HelperForm.buildVersion}"/>
		<script src="template/js/codemirror/mode/xml/xml.js?v=#{HelperForm.buildVersion}"/>
		<!-- Without permission -->
		<h:panelGroup rendered="#{!LoginForm.hasRole('Plugin_administration_ruleset_edition')}">
			<div class="row">
				<div class="col-sm-12">
					<div class="box box-color box-bordered lightgrey">
						<div class="box-title">
							<h3>
								<i class="fa fa-plug"></i>
								<h:outputText
									value="#{msgs[AdministrationForm.administrationPlugin.title]}" />
							</h3>
						</div>
						<div class="box-content">
							<h:outputText
								styleClass="alert alert-danger alert-dismissable margin-bottom-10 margin-top-10"
								value="#{msgs.plugin_administration_missingPermission} Plugin_administration_ruleset_edition"></h:outputText>
						</div>
					</div>
				</div>
			</div>
		</h:panelGroup>

		<!-- With permission -->
		<h:panelGroup rendered="#{LoginForm.hasRole('Plugin_administration_ruleset_edition')}">
			<div class="row">
				<h:form id="rulesetEditorForm">
					<div class="col-sm-4">
						<div class="box box-color box-bordered">
							<div class="box-title">
								<h3>
									<i class="fa fa-files-o"></i>
									<h:outputText value="#{msgs.rulesetSelection}" />
								</h3>
							</div>
							<div class="box-content nopadding">
								<!-- Table with rule set file -->
								<h:dataTable id="ruleset_table" styleClass="table table-hover table-nomargin dataTable table-bordered responsive" var="item"
									value="#{AdministrationForm.administrationPlugin.rulesets}" varStatus="status">
									<h:column>
										<f:facet name="header">
											<h:outputText value="#{msgs.rulesetTitle}" />
										</f:facet>
										<h:outputText value="#{item.titel}"/>
									</h:column>
									<h:column>
										<f:facet name="header">
											<h:outputText value="#{msgs.rulesetFile}" />
										</f:facet>
										<h:outputText value="#{item.datei}" />
									</h:column>
									<h:column>
										<f:facet name="header">
											<h:outputText value="#{msgs.zuletztBearbeitet}" />
										</f:facet>
										<h:outputText value="#{AdministrationForm.administrationPlugin.rulesetDates.get(status.index)}" />
									</h:column>
									<h:column>
										<f:facet name="header">
											<h:outputText value="#{msgs.auswahl}" />
										</f:facet>
										<!-- Edit-Ruleset-Button -->
										<!-- jsf:disabled="#{AdministrationForm.administrationPlugin.currentRuleset == null ? false : true}" -->
										<button
											jsf:id="edit"
											class="btn margin-sides-5 #{AdministrationForm.administrationPlugin.isActiveRuleset(item) ? 'btn-primary' : ''}"
											jsf:rel="tooltip"
											jsf:action="#{AdministrationForm.administrationPlugin.editRuleset(item)}"
											title="#{msgs.regelsatzBearbeiten}">
											<i class="fa fa-pencil"></i>
											<f:ajax render="rulesetEditorForm" />
										</button>
									</h:column>
								</h:dataTable>
							</div>
						</div>
						<div class="box box-color box-bordered lightgrey">
							<div class="box-title">
								<h3>
									<i class="fa fa-bar-chart"></i>
									<h:outputText
										value="#{msgs.validationResult}" />
								</h3>
							</div>
							<div class="box-content">
								<h:panelGroup id="actionform" styleClass="col-sm-12">
									<div class="row">
										<!-- hello adminstration plugin: #{AdministrationForm.administrationPlugin.value} -->
									</div>
								</h:panelGroup>
							</div>
						</div>
					</div>
					<div class="col-sm-8">
						<h:panelGroup rendered="#{AdministrationForm.administrationPlugin.currentRuleset != null}">
							<div class="box box-color box-bordered orange">
								<div class="box-title">
									<h3>
										<i class="fa fa-wrench"></i>
										<h:outputText value="#{AdministrationForm.administrationPlugin.currentEditorTitle}" />
									</h3>
								</div>
								<div class="box-content" id="boxUntilBottom">
									<!-- Buttons on top of text editor -->
									<div class="form-actions">
										<!-- Save-Button -->
										<button
											jsf:id="save-top"
											class="btn btn-success pull-right font-size-s margin-bottom-most"
											jsf:action="#{AdministrationForm.administrationPlugin.save}"
											onclick="loadEditorContent()"
											title="#{msgs.uebernehmen}">
											<i class="fa fa-save margin-right-5"></i>
											<h:outputText value="#{msgs.uebernehmen}" />
											<f:ajax render="rulesetEditorForm" />
										</button>
										<!-- Cancel-Button -->
										<button
											jsf:id="cancel-top"
											class="btn margin-sides-10 font-size-s pull-right"
											jsf:action="#{AdministrationForm.administrationPlugin.cancel}"
											title="#{msgs.cancel}">
											<h:outputText value="#{msgs.cancel}" />
											<f:ajax render="rulesetEditorForm" />
										</button>
									</div>
									<!-- Text editor -->
									<div id="rulesetEditorBorder" style="border: 1px solid #ddd; margin-top: 28px;">
										<x:inputTextarea
											id="rulesetEditor"
											style="resize: none;"
											pt:aria-label="rulesetEditor"
											forceId="true"
											styleClass="form-control"
											value="#{AdministrationForm.administrationPlugin.currentRulesetFileContent}" />
										<script type="text/javascript">
											initRulesetEditor();
										</script>
									</div>
									<!-- Buttons on bottom of text editor -->
									<div class="form-actions">
										<!-- Save-Button -->
										<button
											jsf:id="save-bottom"
											class="btn btn-success pull-right font-size-s margin-bottom-most"
											jsf:action="#{AdministrationForm.administrationPlugin.save}"
											onclick="loadEditorContent()"
											title="#{msgs.uebernehmen}">
											<i class="fa fa-save margin-right-5"></i>
											<h:outputText value="#{msgs.uebernehmen}" />
											<f:ajax render="rulesetEditorForm" />
										</button>
										<!-- Cancel-Button -->
										<button
											jsf:id="cancel-bottom"
											class="btn margin-sides-10 font-size-s pull-right"
											jsf:action="#{AdministrationForm.administrationPlugin.cancel}"
											title="#{msgs.cancel}">
											<h:outputText value="#{msgs.cancel}" />
											<f:ajax render="rulesetEditorForm" />
										</button>
									</div>
								</div>
							</div>
						</h:panelGroup>
						<!-- Box for non-selected file -->
						<h:panelGroup rendered="#{AdministrationForm.administrationPlugin.currentRuleset == null}">
							<div class="box thin-margin lightgrey box-bordered">
								<div
									class="box-title"
									style="background-color: #eee;">
									<h2 class="tableColumnMaxWidthExtraLong">
										<i class="fa fa-wrench"></i> #{msgs.noFileSelected}
									</h2>
								</div>
								<div class="box-content nopadding">
									<div style="background-color: #eee; height: 250px;">
									</div>
								</div>
							</div>
						</h:panelGroup>
					</div>
				</h:form>
			</div>
		</h:panelGroup>
		<script type="text/javascript">
			var rulesetEditor;
			function initRulesetEditor() {
				var rulesetTextArea = document.getElementById("rulesetEditor");
				if (rulesetTextArea) {
					rulesetEditor = CodeMirror.fromTextArea(rulesetTextArea, {
						lineNumbers: true,
						mode: 'xml'
					});
					rulesetEditor.on('change', editor => {
						document.getElementById("rulesetEditor").innerHTML = editor.getValue();
					});
				}
				window.addEventListener('resize', function() {
					setHeightOfTextEditor();
				});
				setHeightOfTextEditor();
			}
			function loadEditorContent() {
				var rulesetTextArea = document.getElementById("rulesetEditor");
				rulesetTextArea.innerHTML = rulesetEditor.getValue();
			}
			function setHeightOfTextEditor() {
				var documentHeight = document.body.clientHeight;
				var offset = $("#boxUntilBottom").offset();
				var xPosition = offset.left - $(window).scrollLeft();
				var yPosition = offset.top - $(window).scrollTop();
				var border = 20;
				var resultHeight = documentHeight - yPosition - border;
				var box = document.getElementById("boxUntilBottom");
				box.style.height = resultHeight + "px";
				var codeMirror = document.getElementsByClassName("CodeMirror")[0];
				codeMirror.style.height = "100%";
				var borderBox = document.getElementById("rulesetEditorBorder");
				// 150 is an estimated height of buttons and spaces
				borderBox.style.height = (resultHeight - 150) + "px";
			}
		</script>
	</composite:implementation>
</ui:composition>